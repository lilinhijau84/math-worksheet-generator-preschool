<!doctype html>
<html lang="en" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Math Worksheet Generator</title>
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&amp;family=Patrick+Hand&amp;display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-color: #fef7cd;
      --surface-color: #ffffff;
      --text-color: #1a1a2e;
      --primary-color: #f97316;
      --secondary-color: #0ea5e9;
      --font-family: 'Nunito', sans-serif;
      --font-size: 16;
    }
    body {
      font-family: var(--font-family), sans-serif;
    }
    .worksheet-font {
      font-family: 'Patrick Hand', cursive;
    }
    @media print {
      .no-print { display: none !important; }
      .print-only { display: block !important; }
    }
    .print-only { display: none; }
    .btn-bounce:active {
      transform: scale(0.95);
    }
    .fade-in {
      animation: fadeIn 0.3s ease-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .problem-grid {
      display: grid;
      gap: 1rem;
    }
  </style>
  <style>body { box-sizing: border-box; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full overflow-auto" style="background-color: var(--bg-color);">
  <div class="min-h-full w-full"><!-- Controls Panel -->
   <div class="no-print p-4 md:p-6 max-w-6xl mx-auto">
    <header class="text-center mb-6">
     <h1 id="main-title" class="text-3xl md:text-4xl font-extrabold mb-2" style="color: var(--text-color); font-size: calc(var(--font-size) * 2.25px);">‚úèÔ∏è Math Worksheet Generator</h1>
     <p class="opacity-75" style="color: var(--text-color); font-size: calc(var(--font-size) * 1px);">Create printable worksheets with answer keys in seconds!</p>
    </header><!-- Settings Card -->
    <div class="rounded-2xl shadow-lg p-4 md:p-6 mb-6 fade-in" style="background-color: var(--surface-color);">
     <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"><!-- Operation Type -->
      <div><label class="block font-bold mb-2" style="color: var(--text-color); font-size: calc(var(--font-size) * 0.875px);">Operation</label> <select id="operation" class="w-full px-4 py-3 rounded-xl border-2 font-semibold transition-all focus:outline-none focus:ring-2" style="border-color: var(--secondary-color); color: var(--text-color); font-size: calc(var(--font-size) * 1px);"> <option value="addition">‚ûï Addition</option> <option value="subtraction">‚ûñ Subtraction</option> <option value="multiplication">‚úñÔ∏è Multiplication</option> <option value="division">‚ûó Division</option> <option value="mixed">üé≤ Mixed</option> </select>
      </div><!-- Number Range -->
      <div><label class="block font-bold mb-2" style="color: var(--text-color); font-size: calc(var(--font-size) * 0.875px);">Number Range</label>
       <div class="flex gap-2 items-center"><input type="number" id="minNum" value="1" min="0" max="999" class="w-full px-3 py-3 rounded-xl border-2 font-semibold focus:outline-none focus:ring-2" style="border-color: var(--secondary-color); color: var(--text-color); font-size: calc(var(--font-size) * 1px);"> <span class="font-bold" style="color: var(--text-color);">to</span> <input type="number" id="maxNum" value="20" min="1" max="999" class="w-full px-3 py-3 rounded-xl border-2 font-semibold focus:outline-none focus:ring-2" style="border-color: var(--secondary-color); color: var(--text-color); font-size: calc(var(--font-size) * 1px);">
       </div>
      </div><!-- Grid Size -->
      <div><label class="block font-bold mb-2" style="color: var(--text-color); font-size: calc(var(--font-size) * 0.875px);">Problems</label> <select id="gridSize" class="w-full px-4 py-3 rounded-xl border-2 font-semibold transition-all focus:outline-none focus:ring-2" style="border-color: var(--secondary-color); color: var(--text-color); font-size: calc(var(--font-size) * 1px);"> <option value="12">12 Problems (3√ó4)</option> <option value="20" selected>20 Problems (4√ó5)</option> <option value="30">30 Problems (5√ó6)</option> <option value="42">42 Problems (6√ó7)</option> </select>
      </div><!-- Paper Size -->
      <div><label class="block font-bold mb-2" style="color: var(--text-color); font-size: calc(var(--font-size) * 0.875px);">Paper Size</label> <select id="paperSize" class="w-full px-4 py-3 rounded-xl border-2 font-semibold transition-all focus:outline-none focus:ring-2" style="border-color: var(--secondary-color); color: var(--text-color); font-size: calc(var(--font-size) * 1px);"> <option value="letter" selected>US Letter</option> <option value="a4">A4</option> </select>
      </div>
     </div><!-- Action Buttons -->
     <div class="flex flex-wrap gap-3 mt-6 justify-center"><button id="generateBtn" class="btn-bounce px-6 py-3 rounded-xl font-bold text-white shadow-lg transition-all hover:shadow-xl hover:scale-105" style="background-color: var(--primary-color); font-size: calc(var(--font-size) * 1px);"> üéØ Generate Worksheet </button> <button id="downloadPdfBtn" class="btn-bounce px-6 py-3 rounded-xl font-bold text-white shadow-lg transition-all hover:shadow-xl hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed" style="background-color: var(--secondary-color); font-size: calc(var(--font-size) * 1px);" disabled> üìÑ Download PDF </button> <button id="downloadPngBtn" class="btn-bounce px-6 py-3 rounded-xl font-bold text-white shadow-lg transition-all hover:shadow-xl hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed" style="background-color: var(--secondary-color); font-size: calc(var(--font-size) * 1px);" disabled> üñºÔ∏è Download PNG </button>
     </div>
    </div><!-- Preview Toggle -->
    <div class="flex justify-center gap-4 mb-4"><button id="showWorksheet" class="px-4 py-2 rounded-lg font-bold transition-all" style="background-color: var(--primary-color); color: white; font-size: calc(var(--font-size) * 0.875px);"> üìù Worksheet </button> <button id="showAnswers" class="px-4 py-2 rounded-lg font-bold transition-all opacity-60 hover:opacity-100" style="background-color: var(--surface-color); color: var(--text-color); font-size: calc(var(--font-size) * 0.875px);"> ‚úÖ Answer Key </button>
    </div>
   </div><!-- Worksheet Preview -->
   <div id="worksheetContainer" class="flex justify-center pb-8 px-4">
    <div id="worksheet" class="worksheet-font bg-white shadow-2xl" style="width: 8.5in; min-height: 11in; padding: 0.5in;">
     <div id="worksheetContent" class="flex flex-col h-full"><!-- Header -->
      <div class="flex justify-between items-start mb-6 border-b-2 border-gray-300 pb-4">
       <div>
        <h2 id="worksheetTitle" class="text-3xl font-bold" style="color: var(--text-color);">Math Practice</h2>
        <p class="text-gray-500 text-sm mt-1">Show your work!</p>
       </div>
       <div class="text-right">
        <div class="flex items-center gap-2 mb-2"><span id="nameLabel" class="font-semibold" style="color: var(--text-color);">Name:</span>
         <div class="border-b-2 border-gray-400 w-48"></div>
        </div>
        <div class="flex items-center gap-2"><span class="font-semibold" style="color: var(--text-color);">Date:</span>
         <div class="border-b-2 border-gray-400 w-32"></div>
        </div>
       </div>
      </div><!-- Problems Grid -->
      <div id="problemsGrid" class="problem-grid flex-1"><!-- Problems will be inserted here -->
      </div><!-- Footer -->
      <div class="mt-6 pt-4 border-t-2 border-gray-200 text-center text-gray-400 text-sm"><span id="footerText">Created with Math Worksheet Generator</span>
      </div>
     </div>
    </div>
   </div><!-- Answer Key (Hidden by default) -->
   <div id="answerContainer" class="hidden flex justify-center pb-8 px-4">
    <div id="answerSheet" class="worksheet-font bg-white shadow-2xl" style="width: 8.5in; min-height: 11in; padding: 0.5in;">
     <div class="flex flex-col h-full">
      <div class="mb-6 border-b-2 border-gray-300 pb-4">
       <h2 class="text-3xl font-bold" style="color: var(--primary-color);">‚úÖ Answer Key</h2>
       <p class="text-gray-500 text-sm mt-1" id="answerSubtitle">Math Practice</p>
      </div>
      <div id="answersGrid" class="problem-grid flex-1"><!-- Answers will be inserted here -->
      </div>
     </div>
    </div>
   </div><!-- Loading Overlay -->
   <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-2xl p-8 text-center shadow-2xl">
     <div class="animate-spin w-12 h-12 border-4 border-gray-300 rounded-full mx-auto mb-4" style="border-top-color: var(--primary-color);"></div>
     <p class="font-bold" style="color: var(--text-color);">Generating your download...</p>
    </div>
   </div><!-- Toast Notification -->
   <div id="toast" class="fixed bottom-4 right-4 px-6 py-3 rounded-xl shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50" style="background-color: var(--primary-color); color: white;"><span id="toastMessage">Worksheet generated!</span>
   </div>
  </div>
  <script>
    const defaultConfig = {
      worksheet_title: 'Math Practice',
      student_name_label: 'Name:',
      background_color: '#fef7cd',
      surface_color: '#ffffff',
      text_color: '#1a1a2e',
      primary_color: '#f97316',
      secondary_color: '#0ea5e9',
      font_family: 'Nunito',
      font_size: 16
    };

    let config = { ...defaultConfig };
    let currentProblems = [];
    let showingAnswers = false;

    // Element SDK initialization
    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange: async (newConfig) => {
          config = { ...defaultConfig, ...newConfig };
          applyConfig();
        },
        mapToCapabilities: (cfg) => ({
          recolorables: [
            {
              get: () => cfg.background_color || defaultConfig.background_color,
              set: (v) => { cfg.background_color = v; window.elementSdk.setConfig({ background_color: v }); }
            },
            {
              get: () => cfg.surface_color || defaultConfig.surface_color,
              set: (v) => { cfg.surface_color = v; window.elementSdk.setConfig({ surface_color: v }); }
            },
            {
              get: () => cfg.text_color || defaultConfig.text_color,
              set: (v) => { cfg.text_color = v; window.elementSdk.setConfig({ text_color: v }); }
            },
            {
              get: () => cfg.primary_color || defaultConfig.primary_color,
              set: (v) => { cfg.primary_color = v; window.elementSdk.setConfig({ primary_color: v }); }
            },
            {
              get: () => cfg.secondary_color || defaultConfig.secondary_color,
              set: (v) => { cfg.secondary_color = v; window.elementSdk.setConfig({ secondary_color: v }); }
            }
          ],
          borderables: [],
          fontEditable: {
            get: () => cfg.font_family || defaultConfig.font_family,
            set: (v) => { cfg.font_family = v; window.elementSdk.setConfig({ font_family: v }); }
          },
          fontSizeable: {
            get: () => cfg.font_size || defaultConfig.font_size,
            set: (v) => { cfg.font_size = v; window.elementSdk.setConfig({ font_size: v }); }
          }
        }),
        mapToEditPanelValues: (cfg) => new Map([
          ['worksheet_title', cfg.worksheet_title || defaultConfig.worksheet_title],
          ['student_name_label', cfg.student_name_label || defaultConfig.student_name_label]
        ])
      });
    }

    function applyConfig() {
      const root = document.documentElement;
      root.style.setProperty('--bg-color', config.background_color || defaultConfig.background_color);
      root.style.setProperty('--surface-color', config.surface_color || defaultConfig.surface_color);
      root.style.setProperty('--text-color', config.text_color || defaultConfig.text_color);
      root.style.setProperty('--primary-color', config.primary_color || defaultConfig.primary_color);
      root.style.setProperty('--secondary-color', config.secondary_color || defaultConfig.secondary_color);
      root.style.setProperty('--font-family', config.font_family || defaultConfig.font_family);
      root.style.setProperty('--font-size', config.font_size || defaultConfig.font_size);

      document.body.style.fontFamily = `${config.font_family || defaultConfig.font_family}, sans-serif`;
      document.body.style.backgroundColor = config.background_color || defaultConfig.background_color;

      // Update text content
      document.getElementById('worksheetTitle').textContent = config.worksheet_title || defaultConfig.worksheet_title;
      document.getElementById('answerSubtitle').textContent = config.worksheet_title || defaultConfig.worksheet_title;
      document.getElementById('nameLabel').textContent = config.student_name_label || defaultConfig.student_name_label;

      // Update buttons and elements with new colors
      document.getElementById('generateBtn').style.backgroundColor = config.primary_color || defaultConfig.primary_color;
      document.getElementById('downloadPdfBtn').style.backgroundColor = config.secondary_color || defaultConfig.secondary_color;
      document.getElementById('downloadPngBtn').style.backgroundColor = config.secondary_color || defaultConfig.secondary_color;

      // Update settings card
      const settingsCard = document.querySelector('.rounded-2xl.shadow-lg');
      if (settingsCard) {
        settingsCard.style.backgroundColor = config.surface_color || defaultConfig.surface_color;
      }
    }

    function getGridDimensions(count) {
      const grids = {
        12: { cols: 3, rows: 4 },
        20: { cols: 4, rows: 5 },
        30: { cols: 5, rows: 6 },
        42: { cols: 6, rows: 7 }
      };
      return grids[count] || { cols: 4, rows: 5 };
    }

    function generateProblem(operation, min, max) {
      let a, b, answer, symbol;
      
      const ops = operation === 'mixed' 
        ? ['addition', 'subtraction', 'multiplication', 'division'][Math.floor(Math.random() * 4)]
        : operation;

      switch (ops) {
        case 'addition':
          a = Math.floor(Math.random() * (max - min + 1)) + min;
          b = Math.floor(Math.random() * (max - min + 1)) + min;
          answer = a + b;
          symbol = '+';
          break;
        case 'subtraction':
          a = Math.floor(Math.random() * (max - min + 1)) + min;
          b = Math.floor(Math.random() * (Math.min(a, max) - min + 1)) + min;
          if (b > a) [a, b] = [b, a];
          answer = a - b;
          symbol = '‚àí';
          break;
        case 'multiplication':
          const multMax = Math.min(max, 12);
          a = Math.floor(Math.random() * (multMax - min + 1)) + min;
          b = Math.floor(Math.random() * (multMax - min + 1)) + min;
          answer = a * b;
          symbol = '√ó';
          break;
        case 'division':
          b = Math.floor(Math.random() * (Math.min(max, 12) - 1)) + 1;
          answer = Math.floor(Math.random() * (Math.min(max, 12) - 1)) + 1;
          a = b * answer;
          symbol = '√∑';
          break;
      }

      return { a, b, symbol, answer };
    }

    function generateWorksheet() {
      const operation = document.getElementById('operation').value;
      const min = parseInt(document.getElementById('minNum').value) || 1;
      const max = parseInt(document.getElementById('maxNum').value) || 20;
      const count = parseInt(document.getElementById('gridSize').value);
      const { cols } = getGridDimensions(count);

      currentProblems = [];
      for (let i = 0; i < count; i++) {
        currentProblems.push(generateProblem(operation, min, max));
      }

      renderProblems(false);
      renderAnswers();

      document.getElementById('downloadPdfBtn').disabled = false;
      document.getElementById('downloadPngBtn').disabled = false;

      showToast('Worksheet generated! üéâ');
    }

    function renderProblems(showAnswers) {
      const grid = document.getElementById('problemsGrid');
      const count = currentProblems.length;
      const { cols } = getGridDimensions(count);

      grid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
      grid.innerHTML = currentProblems.map((p, i) => `
        <div class="border-2 border-gray-200 rounded-xl p-4 text-center bg-gray-50">
          <div class="text-xs text-gray-400 mb-2">#${i + 1}</div>
          <div class="text-2xl font-bold" style="color: var(--text-color);">
            ${p.a} ${p.symbol} ${p.b} = ${showAnswers ? `<span style="color: var(--primary-color);">${p.answer}</span>` : '___'}
          </div>
        </div>
      `).join('');
    }

    function renderAnswers() {
      const grid = document.getElementById('answersGrid');
      const count = currentProblems.length;
      const { cols } = getGridDimensions(count);

      grid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
      grid.innerHTML = currentProblems.map((p, i) => `
        <div class="border-2 rounded-xl p-4 text-center" style="border-color: var(--primary-color); background-color: rgba(249, 115, 22, 0.1);">
          <div class="text-xs text-gray-400 mb-2">#${i + 1}</div>
          <div class="text-2xl font-bold" style="color: var(--text-color);">
            ${p.a} ${p.symbol} ${p.b} = <span style="color: var(--primary-color); font-weight: 800;">${p.answer}</span>
          </div>
        </div>
      `).join('');
    }

    function toggleView(showAnswerKey) {
      showingAnswers = showAnswerKey;
      document.getElementById('worksheetContainer').classList.toggle('hidden', showAnswerKey);
      document.getElementById('answerContainer').classList.toggle('hidden', !showAnswerKey);
      
      const worksheetBtn = document.getElementById('showWorksheet');
      const answersBtn = document.getElementById('showAnswers');
      
      if (showAnswerKey) {
        answersBtn.style.backgroundColor = config.primary_color || defaultConfig.primary_color;
        answersBtn.style.color = 'white';
        answersBtn.classList.remove('opacity-60');
        worksheetBtn.style.backgroundColor = config.surface_color || defaultConfig.surface_color;
        worksheetBtn.style.color = config.text_color || defaultConfig.text_color;
        worksheetBtn.classList.add('opacity-60');
      } else {
        worksheetBtn.style.backgroundColor = config.primary_color || defaultConfig.primary_color;
        worksheetBtn.style.color = 'white';
        worksheetBtn.classList.remove('opacity-60');
        answersBtn.style.backgroundColor = config.surface_color || defaultConfig.surface_color;
        answersBtn.style.color = config.text_color || defaultConfig.text_color;
        answersBtn.classList.add('opacity-60');
      }
    }

    async function downloadPDF() {
      showLoading(true);
      
      try {
        const { jsPDF } = window.jspdf;
        const paperSize = document.getElementById('paperSize').value;
        const format = paperSize === 'a4' ? 'a4' : 'letter';
        
        const pdf = new jsPDF({ orientation: 'portrait', unit: 'in', format });
        
        // Capture worksheet
        const worksheetEl = document.getElementById('worksheet');
        const wsCanvas = await html2canvas(worksheetEl, { 
          scale: 2,
          useCORS: true,
          backgroundColor: '#ffffff'
        });
        
        const imgWidth = paperSize === 'a4' ? 8.27 : 8.5;
        const imgHeight = paperSize === 'a4' ? 11.69 : 11;
        
        pdf.addImage(wsCanvas.toDataURL('image/png'), 'PNG', 0, 0, imgWidth, imgHeight);
        
        // Add answer key page
        pdf.addPage();
        const answerEl = document.getElementById('answerSheet');
        document.getElementById('answerContainer').classList.remove('hidden');
        
        const ansCanvas = await html2canvas(answerEl, {
          scale: 2,
          useCORS: true,
          backgroundColor: '#ffffff'
        });
        
        pdf.addImage(ansCanvas.toDataURL('image/png'), 'PNG', 0, 0, imgWidth, imgHeight);
        
        if (!showingAnswers) {
          document.getElementById('answerContainer').classList.add('hidden');
        }
        
        pdf.save('math-worksheet.pdf');
        showToast('PDF downloaded! üìÑ');
      } catch (err) {
        console.error('PDF generation failed:', err);
        showToast('Download failed. Please try again.');
      }
      
      showLoading(false);
    }

    async function downloadPNG() {
      showLoading(true);
      
      try {
        const target = showingAnswers 
          ? document.getElementById('answerSheet')
          : document.getElementById('worksheet');
        
        const canvas = await html2canvas(target, {
          scale: 2,
          useCORS: true,
          backgroundColor: '#ffffff'
        });
        
        const link = document.createElement('a');
        link.download = showingAnswers ? 'answer-key.png' : 'math-worksheet.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
        
        showToast('PNG downloaded! üñºÔ∏è');
      } catch (err) {
        console.error('PNG generation failed:', err);
        showToast('Download failed. Please try again.');
      }
      
      showLoading(false);
    }

    function showLoading(show) {
      document.getElementById('loadingOverlay').classList.toggle('hidden', !show);
    }

    function showToast(message) {
      const toast = document.getElementById('toast');
      document.getElementById('toastMessage').textContent = message;
      toast.classList.remove('translate-y-20', 'opacity-0');
      
      setTimeout(() => {
        toast.classList.add('translate-y-20', 'opacity-0');
      }, 3000);
    }

    // Event Listeners
    document.getElementById('generateBtn').addEventListener('click', generateWorksheet);
    document.getElementById('downloadPdfBtn').addEventListener('click', downloadPDF);
    document.getElementById('downloadPngBtn').addEventListener('click', downloadPNG);
    document.getElementById('showWorksheet').addEventListener('click', () => toggleView(false));
    document.getElementById('showAnswers').addEventListener('click', () => toggleView(true));

    // Initialize
    applyConfig();
    generateWorksheet();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9d1bb2f7b4051372',t:'MTc3MTczNDExMi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>